<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ممشى الهجر | المسار الرسمي</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        /* إعدادات الشاشة */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; position: fixed; font-family: 'Tajawal', sans-serif;
            background: #000;
        }

        /* الكاميرا */
        #arjs-video, .a-canvas {
            position: absolute !important; top: 0; left: 0;
            width: 100% !important; height: 100% !important;
            z-index: 0 !important; object-fit: cover !important;
            pointer-events: none;
        }

        /* شاشة البداية */
        #splash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1578895210405-927f05f3c8b0?q=80&w=1000');
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; z-index: 9999; transition: opacity 0.5s; text-align: center;
        }

        .title { font-size: 2rem; font-weight: bold; margin-bottom: 10px; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .subtitle { font-size: 1rem; opacity: 0.9; margin-bottom: 30px; max-width: 80%; }

        .btn {
            padding: 15px 50px; background: white; color: #222;
            border: none; border-radius: 50px; font-weight: bold; font-size: 1.1rem;
            cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        /* واجهة اللعب HUD */
        #hud {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100; display: none;
        }

        .hud-box {
            position: absolute; background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.3);
            border-radius: 15px; color: white; font-weight: bold;
            display: flex; align-items: center; gap: 10px; pointer-events: auto;
        }

        #score-panel { top: 20px; right: 20px; padding: 8px 20px; }
        
        #radar-panel {
            top: 20px; left: 20px; width: 90px; height: 90px;
            border-radius: 50%; overflow: hidden; background: rgba(0,0,0,0.5);
        }
        #radar-dot {
            width: 10px; height: 10px; background: #00FF00; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            box-shadow: 0 0 5px #00FF00; border: 2px solid white;
        }

        .signature { position: absolute; bottom: 20px; font-size: 0.8rem; opacity: 0.8; }
        
        /* رسالة انتظار GPS */
        #gps-status {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 5px 15px;
            border-radius: 20px; font-size: 0.8rem; display: none;
        }
    </style>
</head>

<body>

    <div id="splash">
        <h1 class="title">ممشى بلدة الهجر</h1>
        <p class="subtitle">المسار الرسمي (Real Path)<br>استكشف الطبيعة واجمع النقاط</p>
        <button class="btn" onclick="startApp()">ابدأ الرحلة</button>
        <div class="signature">تطوير: المهندس سامي</div>
    </div>

    <div id="hud">
        <div id="score-panel" class="hud-box">النقاط: <span id="score">0</span></div>
        <div id="radar-panel" class="hud-box"><div id="radar-dot"></div></div>
    </div>
    
    <div id="gps-status">جاري البحث عن إشارة GPS...</div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        renderer="logarithmicDepthBuffer: true; precision: high; antialias: true; alpha: true;"
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix;">
        
        <a-camera gps-camera rotation-reader minDistance="1" maxDistance="1500"></a-camera>
    </a-scene>

    <script>
        // --- 1. بيانات المسار الحقيقية (من ملف GeoJSON الخاص بك) ---
        // قمت بوضع البيانات هنا مباشرة لتعمل بدون مشاكل تحميل
        const geoJsonData = {
            "type": "FeatureCollection",
            "features": [{
                "geometry": {
                    "type": "LineString",
                    "coordinates": [
                        [56.92604, 23.28061], [56.926055, 23.28060667], [56.92609667, 23.2806],
                        [56.92610833, 23.28059833], [56.92613833, 23.280595], [56.92616333, 23.28059333],
                        [56.926185, 23.28059], [56.92620333, 23.28058667], [56.926225, 23.28058667],
                        [56.92623667, 23.28058333], [56.92625833, 23.28057333], [56.92627833, 23.28056833],
                        [56.92631, 23.28056667], [56.92632333, 23.28055667], [56.926345, 23.28052667],
                        [56.92635667, 23.28051], [56.92639, 23.28048667], [56.92641, 23.280475],
                        [56.92644167, 23.28045667], [56.92646667, 23.280445], [56.92649667, 23.28043167],
                        [56.92652167, 23.28043167], [56.92654333, 23.28043667], [56.92657333, 23.28043667],
                        [56.92660667, 23.28042667], [56.92663167, 23.280425], [56.92666333, 23.28042333],
                        [56.926705, 23.280415], [56.92688333, 23.28036833], [56.92698833, 23.28032],
                        [56.92706, 23.28027833], [56.92713333, 23.28024833], [56.92781833, 23.28017],
                        [56.92825333, 23.28005], [56.92899, 23.27985], [56.92970333, 23.2796],
                        [56.9303, 23.27927], [56.931495, 23.27887], [56.93247833, 23.27845]
                    ]
                }
            }]
        };

        // حدود منطقة الهجر (للخريطة المصغرة)
        const bounds = { n: 23.2810, s: 23.2780, e: 56.9330, w: 56.9250 };
        
        let score = 0;
        let isStarted = false;

        function startApp() {
            if(isStarted) return;
            isStarted = true;

            const splash = document.getElementById('splash');
            splash.style.opacity = '0';
            setTimeout(() => {
                splash.style.display = 'none';
                document.getElementById('hud').style.display = 'block';
                document.getElementById('gps-status').style.display = 'block';
            }, 500);

            initPathFromGeoJSON();
            startGPSMonitoring();
            
            speak("أهلاً بك في ممشى الهجر. اتبع النقاط البيضاء.");
        }

        // --- معالجة ملف GeoJSON ورسم المسار ---
        function initPathFromGeoJSON() {
            const scene = document.querySelector('a-scene');
            const coordinates = geoJsonData.features[0].geometry.coordinates;

            // GeoJSON يأتي بصيغة [Longitude, Latitude]
            // AR.js يحتاج latitude ثم longitude

            coordinates.forEach((coord, index) => {
                // الفلترة: لا نرسم كل نقطة، نرسم نقطة واحدة كل 3 نقاط لتخفيف الحمل
                // (إلا إذا كانت نقطة انعطاف مهمة)
                if (index % 3 !== 0 && index !== coordinates.length - 1) return;

                const lng = coord[0];
                const lat = coord[1];

                // 1. رسم نقطة المسار (بيضاء)
                const dot = document.createElement('a-entity');
                dot.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng};`);
                dot.innerHTML = `<a-sphere radius="0.4" color="white" material="opacity: 0.9; shader: flat"></a-sphere>`;
                scene.appendChild(dot);

                // 2. وضع الذهب (كل 10 نقاط)
                if (index % 10 === 0) {
                    const coin = document.createElement('a-entity');
                    // نضع الذهب بجانب المسار قليلاً
                    coin.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng};`);
                    // رفع الذهب للأعلى قليلاً (position y=1)
                    coin.innerHTML = `<a-octahedron radius="0.5" position="0 1 0" color="#FFD700" 
                        animation="property: rotation; to: 0 360 0; loop: true; dur: 3000"
                        material="metalness: 1; roughness: 0"></a-octahedron>`;
                    
                    coin.addEventListener('click', () => {
                        if(coin.getAttribute('visible') !== 'false') {
                            coin.setAttribute('visible', 'false');
                            score += 25;
                            document.getElementById('score').innerText = score;
                            speak("أحسنت");
                        }
                    });
                    scene.appendChild(coin);
                }
            });
        }

        // --- مراقبة الموقع والرادار ---
        function startGPSMonitoring() {
            navigator.geolocation.watchPosition(pos => {
                document.getElementById('gps-status').style.display = 'none'; // إخفاء رسالة البحث
                
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                
                // تحديث الرادار
                const y = ((bounds.n - lat) / (bounds.n - bounds.s)) * 100;
                const x = ((lng - bounds.w) / (bounds.e - bounds.w)) * 100;
                
                const dot = document.getElementById('radar-dot');
                dot.style.top = Math.min(Math.max(y, 5), 95) + '%';
                dot.style.left = Math.min(Math.max(x, 5), 95) + '%';

            }, (err) => {
                document.getElementById('gps-status').innerText = "تنبيه: إشارة GPS ضعيفة";
            }, { enableHighAccuracy: true, maximumAge: 0 });
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ar-SA';
                window.speechSynthesis.speak(u);
            }
        }
        
        window.addEventListener('resize', () => { document.querySelector('a-scene').resize(); });
    </script>
</body>
</html>
