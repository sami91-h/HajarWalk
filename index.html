<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù…Ù…Ø´Ù‰ Ø§Ù„Ù‡Ø¬Ø± | Ù†ÙŠÙˆÙ†</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;700&display=swap" rel="stylesheet">
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        /* --- ØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠ (Dark Mode / Neon) --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Tajawal', sans-serif; }

        #arjs-video { width: 100% !important; height: 100% !important; object-fit: cover !important; position: absolute !important; top: 0; left: 0; z-index: 0 !important; }
        .a-canvas { z-index: 1 !important; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        #ui-layer { position: fixed; inset: 0; z-index: 100; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        #splash {
            position: absolute; inset: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, #000000 100%), url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=1000');
            background-size: cover; display: flex; flex-direction: column; justify-content: flex-end; padding: 40px; z-index: 999; color: white; transition: transform 0.6s ease-in-out;
        }

        h1 { font-size: 3rem; margin: 0; background: linear-gradient(90deg, #00f2ff, #00ff88); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 20px rgba(0, 255, 136, 0.5); }
        p { opacity: 0.8; margin-bottom: 30px; font-size: 1.1rem; }

        .neon-btn {
            background: transparent; color: #00ff88; border: 2px solid #00ff88;
            padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1.2rem;
            width: 100%; cursor: pointer; box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
            transition: all 0.3s; text-transform: uppercase; letter-spacing: 2px;
        }
        .neon-btn:active { background: #00ff88; color: black; box-shadow: 0 0 30px #00ff88; }

        /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ± */
        #notification {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7); border: 1px solid #00f2ff;
            color: #00f2ff; padding: 10px 20px; border-radius: 50px;
            font-size: 0.9rem; opacity: 0; transition: opacity 0.5s;
            backdrop-filter: blur(5px);
        }

        .hud-element {
            background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px;
            color: white; padding: 10px 15px; font-weight: bold; display: flex; align-items: center; gap: 10px;
        }
    </style>
</head>

<body>

    <div id="splash">
        <h1>NEON WALK</h1>
        <p>Ù…Ù…Ø´Ù‰ Ø§Ù„Ù‡Ø¬Ø±: Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</p>
        <button class="neon-btn" onclick="startExperience()">CONNECT SYSTEM</button>
    </div>

    <div id="ui-layer" style="display:none;">
        <div class="hud-element" style="align-self: flex-start;">
            <div style="width:10px; height:10px; background:#00ff88; border-radius:50%; box-shadow:0 0 10px #00ff88;"></div>
            Ù†Ø´Ø·
        </div>
        <div id="notification">ğŸ“¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø¹Ù„Ù… Ù‚Ø±ÙŠØ¨!</div>
        <div class="hud-element" style="align-self: center;">ØªØ·ÙˆÙŠØ±: Ù…. Ø³Ø§Ù…ÙŠ</div>
    </div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix;"
        renderer="logarithmicDepthBuffer: true; precision: high; antialias: true; alpha: true;">
        
        <a-camera gps-camera rotation-reader minDistance="1" maxDistance="2000"></a-camera>
        
        <a-assets>
            <img id="img1" src="https://images.unsplash.com/photo-1542359649-31e03cd4d909?w=500">
            <img id="img2" src="https://images.unsplash.com/photo-1555400038-63f5ba517a47?w=500">
            <img id="img3" src="https://images.unsplash.com/photo-1517705008128-161945c9148f?w=500">
        </a-assets>

    </a-scene>

    <script>
        // --- 1. Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (GeoJSON) ---
        const pathData = [
            [56.92604, 23.28061], [56.92609, 23.2806], [56.92613, 23.28059], 
            [56.92620, 23.28058], [56.92625, 23.28057], [56.92631, 23.28056],
            [56.92634, 23.28052], [56.92639, 23.28048], [56.92644, 23.28045],
            [56.92649, 23.28043], [56.92654, 23.28043], [56.92660, 23.28042],
            [56.92670, 23.28041], [56.92688, 23.28036], [56.92698, 23.28032],
            [56.92706, 23.28027], [56.92713, 23.28024], [56.92781, 23.28017],
            [56.92825, 23.28005], [56.92899, 23.27985], [56.92970, 23.2796],
            [56.93030, 23.27927], [56.93149, 23.27887], [56.93247, 23.27845]
        ];

        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        let surprisePoints = [];

        async function startExperience() {
            // Ø·Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            try {
                await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                
                document.getElementById('splash').style.transform = 'translateY(-100%)';
                setTimeout(() => {
                    document.getElementById('splash').style.display = 'none';
                    document.getElementById('ui-layer').style.display = 'flex';
                    
                    initNeonPath();
                    generateRandomSurprises();
                    startProximityCheck(); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ
                    
                    speak("ØªÙ… ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…ØªÙˆÙ‡Ø¬. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø®ÙÙŠØ©.");
                }, 600);
            } catch (e) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§"); }
        }

        // --- 2. Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…ØªÙˆÙ‡Ø¬ (Neon Line) ---
        function initNeonPath() {
            const scene = document.querySelector('a-scene');
            
            pathData.forEach((pt, i) => {
                // ÙÙ„ØªØ±Ø© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ¬Ø¹Ù„ Ø§Ù„Ø®Ø· Ù…ØªØµÙ„ Ø¨ØµØ±ÙŠØ§Ù‹
                if (i % 2 !== 0) return;

                const lng = pt[0];
                const lat = pt[1];

                const dot = document.createElement('a-entity');
                dot.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng};`);
                
                // ØªØµÙ…ÙŠÙ… "Ø§Ù„Ù†ÙŠÙˆÙ†": Ø§Ø³Ø·ÙˆØ§Ù†Ø© Ù…Ø¶ÙŠØ¦Ø© Ø¨Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ù† (Cyan)
                dot.innerHTML = `
                    <a-cylinder height="0.1" radius="0.3" 
                        material="color: #00f2ff; opacity: 0.6; transparent: true; emissive: #00f2ff; emissiveIntensity: 2"
                        animation="property: material.opacity; to: 0.2; dir: alternate; dur: 1500; loop: true">
                    </a-cylinder>
                    <a-light type="point" intensity="0.5" distance="2" color="#00f2ff" position="0 0.5 0"></a-light>
                `;
                scene.appendChild(dot);
            });
        }

        // --- 3. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© ---
        function generateRandomSurprises() {
            const scene = document.querySelector('a-scene');
            const images = ['#img1', '#img2', '#img3'];
            
            // Ù†Ø®ØªØ§Ø± 3 Ø£Ù…Ø§ÙƒÙ† Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø±
            for(let k=0; k<3; k++) {
                // Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± (ØªØ¬Ù†Ø¨ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©)
                const randomIndex = Math.floor(Math.random() * (pathData.length - 2)) + 1;
                const pt = pathData[randomIndex];
                const imgID = images[k % images.length];

                // Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙŠØ§Ù† Ø§Ù„ØµÙˆØ±Ø© (Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)
                const entity = document.createElement('a-entity');
                entity.setAttribute('gps-entity-place', `latitude: ${pt[1]}; longitude: ${pt[0]};`);
                entity.setAttribute('id', `surprise-${k}`);
                entity.setAttribute('data-triggered', 'false'); // Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§ÙÙ‡ Ø¨Ø¹Ø¯
                
                // ØªØµÙ…ÙŠÙ… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¹ØµØ±ÙŠØ© (Ø¥Ø·Ø§Ø± Ù…ØªÙˆÙ‡Ø¬)
                entity.innerHTML = `
                    <a-image src="${imgID}" scale="0 0 0" position="0 2 0" look-at="[gps-camera]"
                        animation__show="property: scale; to: 3 2 1; dur: 1000; startEvents: show"
                        material="opacity: 0.9; alphaTest: 0.5">
                    </a-image>
                    <a-ring radius-inner="0.1" radius-outer="0.2" color="#00ff88" position="0 1 0"
                        animation="property: scale; to: 5 5 5; dur: 2000; loop: true; easing: easeOutQuad"
                        material="opacity: 0.5; transparent: true">
                    </a-ring>
                `;
                
                scene.appendChild(entity);
                
                // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
                surprisePoints.push({
                    lat: pt[1],
                    lng: pt[0],
                    id: `surprise-${k}`,
                    el: entity
                });
            }
        }

        // --- 4. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© (Proximity Trigger) ---
        function startProximityCheck() {
            navigator.geolocation.watchPosition(pos => {
                const myLat = pos.coords.latitude;
                const myLng = pos.coords.longitude;

                surprisePoints.forEach(poi => {
                    const dist = getDistance(myLat, myLng, poi.lat, poi.lng);
                    
                    // Ø¥Ø°Ø§ Ø§Ù‚ØªØ±Ø¨Øª Ù„Ù…Ø³Ø§ÙØ© 15 Ù…ØªØ± ÙˆÙ„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ù…Ù† Ù‚Ø¨Ù„
                    if (dist < 15 && poi.el.getAttribute('data-triggered') === 'false') {
                        triggerSurprise(poi);
                    }
                });
            }, null, { enableHighAccuracy: true });
        }

        // --- 5. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙØ§Ø¬Ø£Ø© (ØµÙˆØª + ØµÙˆØ±Ø©) ---
        function triggerSurprise(poi) {
            // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© "ØªÙ… Ø§Ù„Ø§ÙƒØªØ´Ø§Ù"
            poi.el.setAttribute('data-triggered', 'true');
            
            // ØªØ´ØºÙŠÙ„ Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„ØµÙˆØ±Ø©
            const imgEl = poi.el.querySelector('a-image');
            imgEl.emit('show'); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù€ animation Ø§Ù„Ù…Ø±Ø¨ÙˆØ· Ø¨Ø­Ø¯Ø« show
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±
            const notif = document.getElementById('notification');
            notif.style.opacity = '1';
            setTimeout(() => { notif.style.opacity = '0'; }, 3000);

            // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            speak("Ù„Ù‚Ø¯ Ø§ÙƒØªØ´ÙØª Ù…Ø­Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©! Ø§Ù†Ø¸Ø± Ù„Ù„ØµÙˆØ±Ø© Ø£Ù…Ø§Ù…Ùƒ.");
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (Haversine Formula) Ø¨Ø§Ù„Ù…ØªØ±
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ar-SA';
                window.speechSynthesis.speak(u);
            }
        }
        
        window.addEventListener('resize', () => { document.querySelector('a-scene').resize(); });
    </script>
</body>
</html>
