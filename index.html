<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù…Ù…Ø´Ù‰ Ø§Ù„Ù‡Ø¬Ø± | Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù…ÙŠ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        /* --- Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø³ÙŠÙ†Ù…Ø§Ø¦ÙŠ --- */
        :root { --gold: #FFD700; --glass: rgba(20, 20, 20, 0.6); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Tajawal', sans-serif; }
        
        #arjs-video { width: 100% !important; height: 100% !important; object-fit: cover !important; position: absolute !important; top: 0; left: 0; z-index: 0 !important; }
        .a-canvas { z-index: 1 !important; position: absolute !important; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        #splash {
            position: fixed; inset: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1518531933037-91b2f5f229cc?q=80&w=1000');
            background-size: cover; display: flex; flex-direction: column; justify-content: flex-end; padding: 30px; z-index: 9999; color: white; transition: 0.5s;
        }
        .btn { background: var(--gold); color: #000; border: none; padding: 18px; width: 100%; border-radius: 24px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 0 30px rgba(255, 215, 0, 0.4); }

        /* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„ØµÙˆØ± */
        #notification {
            position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8); border: 1px solid var(--gold);
            padding: 10px 20px; border-radius: 30px; color: var(--gold);
            font-weight: bold; display: none; z-index: 200; animation: popIn 0.5s;
        }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ø¹Ø¨ */
        #hud { position: fixed; inset: 0; pointer-events: none; z-index: 100; display: none; padding: 20px; }
        .radar { width: 80px; height: 80px; border-radius: 50%; background: var(--glass); border: 2px solid rgba(255,255,255,0.2); position: relative; overflow: hidden; }
        #radar-dot { width: 10px; height: 10px; background: #0f0; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); }
        .footer { position: absolute; bottom: 30px; width: 100%; text-align: center; color: rgba(255,255,255,0.6); font-size: 0.8rem; }

        @keyframes popIn { from { transform: translate(-50%, -20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
    </style>
</head>

<body>

    <div id="splash">
        <h1 style="font-size: 2.5rem; margin-bottom: 5px; color: var(--gold);">Ù…Ù…Ø´Ù‰ Ø§Ù„Ù‡Ø¬Ø±</h1>
        <p style="opacity: 0.8; margin-bottom: 30px;">Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠØ¡ & Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</p>
        <button class="btn" onclick="startExp()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø© ğŸš€</button>
    </div>

    <div id="notification">ğŸ“¸ Ø§ÙƒØªØ´ÙØª ØµÙˆØ±Ø© ØªØ§Ø±ÙŠØ®ÙŠØ©!</div>

    <div id="hud">
        <div class="radar"><div id="radar-dot"></div></div>
        <div class="footer">ØªØ·ÙˆÙŠØ±: Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø³Ø§Ù…ÙŠ</div>
    </div>

    <a-scene vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; debugUIEnabled: false;" renderer="logarithmicDepthBuffer: true; precision: high; antialias: true; alpha: true;">
        <a-camera gps-camera rotation-reader minDistance="1" maxDistance="2000"></a-camera>
    </a-scene>

    <script>
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
        const pathCoords = [
            [56.92604, 23.28061], [56.92609, 23.2806], [56.92613, 23.28059], 
            [56.92620, 23.28058], [56.92625, 23.28057], [56.92631, 23.28056],
            [56.92634, 23.28052], [56.92639, 23.28048], [56.92644, 23.28045],
            [56.92649, 23.28043], [56.92654, 23.28043], [56.92660, 23.28042],
            [56.92670, 23.28041], [56.92688, 23.28036], [56.92698, 23.28032],
            [56.92706, 23.28027], [56.92713, 23.28024], [56.92781, 23.28017],
            [56.92825, 23.28005], [56.92899, 23.27985], [56.92970, 23.2796],
            [56.93030, 23.27927], [56.93149, 23.27887], [56.93247, 23.27845]
        ];

        // ØµÙˆØ± Ù„Ù„Ø¹Ø±Ø¶ (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¨ØµÙˆØ±Ùƒ Ø§Ù„Ø®Ø§ØµØ©)
        const galleryImages = [
            "https://images.unsplash.com/photo-1545231027-637d2f6210f8?w=500", // Ù†Ø®ÙŠÙ„
            "https://images.unsplash.com/photo-1596524430615-b46475ddff6e?w=500", // ÙÙ„Ø¬
            "https://images.unsplash.com/photo-1578895210405-927f05f3c8b0?w=500"  // Ø¬Ø¨Ø§Ù„
        ];

        async function startExp() {
            try {
                await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.getVoices();
                }

                document.getElementById('splash').style.display = 'none';
                document.getElementById('hud').style.display = 'block';
                initAR();
                startTracking();
                speak("ÙŠØ§ Ù‡Ù„Ø§ ÙˆÙ…Ø±Ø­Ø¨Ø§ ÙÙŠÙƒ ÙÙŠ Ù…Ù…Ø´Ù‰ Ø§Ù„Ù‡Ø¬Ø±. Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø±Ø¶ÙŠ Ø§Ù„Ù…ØªÙˆÙ‡Ø¬.");
            } catch (e) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§"); }
        }

        function initAR() {
            const scene = document.querySelector('a-scene');
            
            pathCoords.forEach((pt, i) => {
                const [lng, lat] = pt;

                // 1. Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø±Ø¶ÙŠ Ø§Ù„Ù…ØªÙˆÙ‡Ø¬ (Ø³Ø¬Ø§Ø¯Ø© Ø¶ÙˆØ¦ÙŠØ©)
                const floorDot = document.createElement('a-entity');
                floorDot.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng};`);
                floorDot.innerHTML = `<a-circle radius="0.8" color="#FFD700" rotation="-90 0 0" material="opacity: 0.6; transparent: true; shader: flat"></a-circle>`;
                scene.appendChild(floorDot);

                // 2. ØµÙˆØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
                if (i > 0 && i % 6 === 0) {
                    const imgIndex = (i / 6) % galleryImages.length;
                    createARImage(lat, lng, galleryImages[imgIndex], scene, i);
                }
            });
        }

        function createARImage(lat, lng, imgSrc, scene, id) {
            const container = document.createElement('a-entity');
            container.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng};`);
            container.setAttribute('look-at', '[gps-camera]'); 
            
            container.setAttribute('visible', 'false'); 
            container.setAttribute('class', 'ar-image-marker');
            container.setAttribute('data-lat', lat);
            container.setAttribute('data-lng', lng);
            container.setAttribute('data-id', id);

            container.innerHTML = `
                <a-image src="${imgSrc}" width="3" height="2" position="0 2 0"></a-image>
                <a-plane width="3.2" height="2.2" position="0 2 -0.1" color="black" material="opacity: 0.7"></a-plane>
                <a-text value="Ù…Ø¹Ù„Ù… ØªØ§Ø±ÙŠØ®ÙŠ" align="center" position="0 0.8 0" color="gold" scale="1.5 1.5 1.5"></a-text>
            `;
            
            scene.appendChild(container);
        }

        function startTracking() {
            navigator.geolocation.watchPosition(pos => {
                const userLat = pos.coords.latitude;
                const userLng = pos.coords.longitude;
                
                updateRadar(userLat, userLng);

                document.querySelectorAll('.ar-image-marker').forEach(marker => {
                    const mLat = parseFloat(marker.getAttribute('data-lat'));
                    const mLng = parseFloat(marker.getAttribute('data-lng'));
                    const dist = getDistance(userLat, userLng, mLat, mLng);

                    if (dist < 20 && marker.getAttribute('visible') === 'false') {
                        marker.setAttribute('visible', 'true');
                        marker.setAttribute('animation', 'property: scale; from: 0 0 0; to: 1 1 1; dur: 1000; easing: easeOutElastic');
                        
                        showNotification();
                        speak("ÙˆØµÙ„Øª Ù„Ù…Ø¹Ù„Ù… ØªØ§Ø±ÙŠØ®ÙŠ. Ø´ÙˆÙ Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¯Ø§Ù…Ùƒ.");
                    }
                });

            }, null, { enableHighAccuracy: true });
        }

        function updateRadar(lat, lng) {
            const bounds = { n: 23.2810, s: 23.2780, e: 56.9330, w: 56.9250 };
            const y = ((bounds.n - lat) / (bounds.n - bounds.s)) * 100;
            const x = ((lng - bounds.w) / (bounds.e - bounds.w)) * 100;
            const dot = document.getElementById('radar-dot');
            dot.style.top = Math.min(Math.max(y, 10), 90) + '%';
            dot.style.left = Math.min(Math.max(x, 10), 90) + '%';
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function showNotification() {
            const notif = document.getElementById('notification');
            notif.style.display = 'block';
            setTimeout(() => { notif.style.display = 'none'; }, 4000);
        }

        // --- Ø¯Ø§Ù„Ø© Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø­Ø³Ù†Ø© (Ù†Ø¨Ø±Ø© Ø®Ù„ÙŠØ¬ÙŠØ© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©) ---
        function speak(text) {
            if ('speechSynthesis' in window) {
                // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ØµÙˆØª Ø³Ø§Ø¨Ù‚
                window.speechSynthesis.cancel();

                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ar-SA'; 
                u.rate = 0.85; // Ø¥Ø¨Ø·Ø§Ø¡ Ø§Ù„Ø³Ø±Ø¹Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„ÙˆÙ‚Ø§Ø±
                u.pitch = 0.9; // Ø®ÙØ¶ Ø§Ù„Ø·Ø¨Ù‚Ø© Ù„Ù„ØµÙˆØª Ø§Ù„Ø°ÙƒÙˆØ±ÙŠ

                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØª Ø¹Ø±Ø¨ÙŠ Ø¬ÙŠØ¯ (Ù…Ø«Ù„ Maged Ø£Ùˆ Tariq)
                const voices = window.speechSynthesis.getVoices();
                const arabicVoice = voices.find(v => v.lang.includes('ar') && (v.name.includes('Maged') || v.name.includes('Tariq') || v.name.includes('Google')));
                
                if (arabicVoice) {
                    u.voice = arabicVoice;
                }

                window.speechSynthesis.speak(u);
            }
        }
    </script>
</body>
</html>
