<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù…Ù…Ø´Ù‰ Ø§Ù„Ù‡Ø¬Ø± | ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        /* --- 1. Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ø§Ù„Ø£Ø³ÙˆØ¯ (Video Fullscreen Fix) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            width: 100%; height: 100%; overflow: hidden;
            background-color: #000; font-family: 'Tajawal', sans-serif;
        }

        /* Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ…Ø±ÙƒØ² ÙˆØ§Ù„ØªÙ…Ø¯Ø¯ */
        #arjs-video {
            width: auto !important; height: auto !important;
            min-width: 100% !important; min-height: 100% !important;
            position: absolute !important;
            top: 50% !important; left: 50% !important;
            transform: translate(-50%, -50%) !important;
            object-fit: cover !important; z-index: -2 !important;
        }

        /* --- 2. Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© (Glass HUD) --- */
        #ui-layer {
            position: absolute; inset: 0; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            z-index: 100;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        #splash {
            position: absolute; inset: 0;
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1518531933037-91b2f5f229cc?w=1000');
            background-size: cover; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; color: white; 
            z-index: 999; text-align: center; pointer-events: auto;
        }

        .start-btn {
            background: #FFD700; color: #000; padding: 15px 50px;
            border: none; border-radius: 50px; font-weight: bold; font-size: 1.2rem;
            margin-top: 30px; cursor: pointer; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: pulse 2s infinite;
        }

        /* Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯ */
        .hud-top { padding: 20px; display: flex; justify-content: space-between; width: 100%; }
        
        .radar-box {
            width: 90px; height: 90px; border-radius: 50%;
            background: rgba(20, 20, 20, 0.6); border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px); position: relative; overflow: hidden;
        }
        #radar-dot {
            width: 10px; height: 10px; background: #00ff88; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 0 8px #00ff88; border: 2px solid white; transition: top 0.5s, left 0.5s;
        }

        .score-box {
            background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(10px);
            padding: 10px 20px; border-radius: 20px; color: #FFD700; font-weight: bold;
            border: 1px solid rgba(255, 215, 0, 0.3); display: flex; align-items: center; gap: 5px;
        }

        .msg-box {
            position: absolute; bottom: 80px; width: 100%; text-align: center;
            color: white; text-shadow: 0 2px 4px black; font-size: 0.9rem;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>

<body>

    <div id="splash">
        <h1 style="font-size: 2.5rem; margin-bottom: 10px;">Ù…Ù…Ø´Ù‰ Ø§Ù„Ù‡Ø¬Ø±</h1>
        <p style="opacity: 0.8;">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© (ÙŠØ¹Ù…Ù„ ÙÙŠ Ù…ÙƒØ§Ù†Ùƒ)</p>
        <button class="start-btn" onclick="startSystem()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© ğŸ“</button>
    </div>

    <div id="ui-layer" style="display:none;">
        <div class="hud-top">
            <div class="radar-box"><div id="radar-dot"></div></div>
            <div class="score-box">ğŸ’ <span id="score">0</span></div>
        </div>
        <div class="msg-box" id="status-msg">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ ÙˆØ±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø±...</div>
        <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.5); font-size: 0.8rem;">ØªØ·ÙˆÙŠØ±: Ù…. Ø³Ø§Ù…ÙŠ</div>
    </div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix;"
        renderer="logarithmicDepthBuffer: true; precision: high; antialias: true; alpha: true;">
        
        <a-camera gps-camera rotation-reader minDistance="1" maxDistance="3000"></a-camera>
    </a-scene>

    <script>
        let score = 0;
        let userStartLat = null;
        let userStartLng = null;

        function startSystem() {
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            document.getElementById('splash').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
            
            // 1. Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(initLocationSuccess, initLocationError, {
                    enableHighAccuracy: true
                });
            } else {
                alert("Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS");
            }
        }

        function initLocationSuccess(position) {
            // Ø­ÙØ¸ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„ØªÙƒÙˆÙ† Ù‡ÙŠ "Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø§Ø¯Ø§Ø±"
            userStartLat = position.coords.latitude;
            userStartLng = position.coords.longitude;
            
            document.getElementById('status-msg').innerText = "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹! Ø§Ù†Ø¸Ø± Ø­ÙˆÙ„Ùƒ...";
            speak("ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ. Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØ§Ù„Ø°Ù‡Ø¨ Ù…Ø±Ø³ÙˆÙ…Ø§Ù† Ø­ÙˆÙ„Ùƒ Ø§Ù„Ø¢Ù†.");

            // 2. Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØ§Ù„Ø°Ù‡Ø¨ (Ø­ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
            generatePathAroundUser(userStartLat, userStartLng);

            // 3. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ
            startRadarTracking();
        }

        function initLocationError(err) {
            alert("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©.");
        }

        // --- Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± (Ø­ÙˆÙ„Ùƒ) ---
        function generatePathAroundUser(lat, lng) {
            const scene = document.querySelector('a-scene');
            
            // Ø³Ù†Ø±Ø³Ù… 10 Ù†Ù‚Ø§Ø· ØªÙ…ØªØ¯ Ù„Ù„Ø´Ù…Ø§Ù„ Ù…Ù†Ùƒ (Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø´ÙŠ)
            for(let i=1; i<=10; i++) {
                // ÙƒÙ„ 0.0001 Ø¯Ø±Ø¬Ø© ØªØ³Ø§ÙˆÙŠ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ 10 Ø£Ù…ØªØ§Ø±
                const newLat = lat + (i * 0.00015);
                const newLng = lng; 

                // Ù†Ù‚Ø·Ø© Ø¨ÙŠØ¶Ø§Ø¡
                const dot = document.createElement('a-entity');
                dot.setAttribute('gps-entity-place', `latitude: ${newLat}; longitude: ${newLng};`);
                dot.innerHTML = `<a-sphere radius="0.5" color="white" material="opacity: 0.9"></a-sphere>`;
                scene.appendChild(dot);

                // Ø°Ù‡Ø¨ (ÙƒÙ„ Ù†Ù‚Ø·ØªÙŠÙ†)
                if(i % 2 === 0) {
                    const coin = document.createElement('a-entity');
                    coin.setAttribute('gps-entity-place', `latitude: ${newLat}; longitude: ${newLng + 0.00005};`); // Ø¥Ø²Ø§Ø­Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ÙŠÙ…ÙŠÙ†
                    coin.innerHTML = `<a-octahedron radius="0.6" position="0 1 0" color="#FFD700" 
                        animation="property: rotation; to: 0 360 0; loop: true; dur: 3000"></a-octahedron>`;
                    
                    coin.addEventListener('click', () => {
                        if(coin.getAttribute('visible') !== 'false') {
                            coin.setAttribute('visible', 'false');
                            score += 50;
                            document.getElementById('score').innerText = score;
                            speak("Ø£Ø­Ø³Ù†Øª! Ù‚Ø·Ø¹Ø© Ø°Ù‡Ø¨ÙŠØ©.");
                        }
                    });
                    scene.appendChild(coin);
                }
            }
        }

        // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ ---
        function startRadarTracking() {
            navigator.geolocation.watchPosition(pos => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙ†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                // Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙŠØºØ·ÙŠ Ù…Ø³Ø§Ø­Ø© 200 Ù…ØªØ± Ø­ÙˆÙ„Ùƒ (0.002 Ø¯Ø±Ø¬Ø©)
                const range = 0.002; 
                
                const dLat = lat - userStartLat;
                const dLng = lng - userStartLng;
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙØ±Ù‚ Ø¥Ù„Ù‰ Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© (50% Ù‡Ùˆ Ø§Ù„Ù…Ù†ØªØµÙ)
                // Ù†Ø¶Ø±Ø¨ ÙÙŠ (50 / range) Ù„Ù„ØªÙƒØ¨ÙŠØ±
                let y = 50 - (dLat * (50 / range)); 
                let x = 50 + (dLng * (50 / range));
                
                // ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ù†Ù‚Ø·Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© (0% Ø¥Ù„Ù‰ 100%)
                y = Math.min(Math.max(y, 10), 90);
                x = Math.min(Math.max(x, 10), 90);
                
                const dot = document.getElementById('radar-dot');
                dot.style.top = y + '%';
                dot.style.left = x + '%';

            }, null, { enableHighAccuracy: true });
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ar-SA';
                window.speechSynthesis.speak(u);
            }
        }
        
        // Ø¥ØµÙ„Ø§Ø­ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ¯ÙˆÙŠØ±
        window.addEventListener('resize', () => {
            document.querySelector('a-scene').resize();
        });
    </script>
</body>
</html>
